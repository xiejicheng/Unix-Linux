## 第二章 用户、文件操作与联机帮助：编写 who 命令

**概念与技巧**

- 联机帮助的作用与使用方法
- Unix 的为文件操作函数：`open` 、`read`  、`write`  、 `lseek` 、 `close`  
- 文件的建立与读写
- 文件描述符
- 缓冲：用户级的缓冲与内核级的缓冲
- 内核模式、用户模式与系统调用的代价
- Unix 表示时间的方法和时间格式间的转换
- 借助 utmp 文件来列出已登录的用户
- 系统调用中的错误检测与处理

**相关的系统调用**

- `open` 、`read`  、`write`  、`creat`  、 `lseek` 、 `close`  
- `perror`

**相关命令**

- man
- who
- cp
- login

### 2.1 介 绍

`who`  命令用于显示系统中活动用户的情况。

通过分析 `who`  命令学习 Unix 的文件操作，还将学习 Unix 下的联机帮助。



### 2.2 关于命令 who

本章第一个程序围绕着三个问题来学习：

- who 命令能做什么？
- who 命令是如何工作的？
- 如何编写 who 命令？

**命令也是程序**

Unix 系统中所有命令的是编写的程序，大多数是使用C语言写的。

系统命令一般放在以下目录里：`/bin` 、 `/usr/bin` 、 `/usr/local/bin` 。

目录里的都是标准命令，你也可以编写自己的命令。



### 2.3 问题1：who 命令能做些什么

在终端输入 who 命令，输出如下：

```bash
$ who
yijiu    tty7         2019-05-18 17:13 (:0)
root     tty3		  2019-05-18 19:17 (:0)
```

每一行代表一个已经登录的用户

第一列是用户名

第二列是终端名

第三列是登录时间

**阅读手册**

进一步了解 who 的用法，需要借助联机帮助。

联机帮助的命令是 man ，查看 who 的帮助，输入：

```bash
$ man who
WHO(1)                          User Commands                         WHO(1)

NAME
       who - show who is logged on

SYNOPSIS
       who [OPTION]... [ FILE | ARG1 ARG2 ]

DESCRIPTION
       Print information about users who are currently logged in.

       -a, --all
              same as -b -d --login -p -r -t -T -u

       -b, --boot
              time of last system boot

       -d, --dead
              print dead processes

       -H, --heading
              print line of column headings

 Manual page who(1) line 1/85 24% (press h for help or q to quit)
 
...
```

联机帮助都有相同的基本格式

从第一行的 WHO(1) 可知这是 who 命令的帮助，小结编号是1， Unix 联机帮助有很多节：

- 第1节是关于用户命令的帮助
- 第2节是关于系统调用的帮助
- 第5节是关于配置文件的帮助

联机帮助的结构：

- 名字（NAME）：包括命令名字与命令的简短说明
- 概要（SYNOPSIS）：给出了命令的用法说明，包括**命令格式、参数和选项列表**。选项指的是一个 `-`  短线候面跟着一个或多个英文字母，如-a、-Bc 等等。命令的选项会影响命令所进行的操作。
- 描述（DESCRIPTION）：关于命令的详细阐述，不同系统会存在不同的描述内容，其中包含许多例子。它描述了命令所有功能，是权威解释。
- 选项（OPTIONS）：给出了每个选项的说明。
- 参阅（SEE ALSO）：其他主题。



### 2.4 问题2：who 命令是如何工作的？

已知 who 命令是用来显示出当前中已登录的用户信息。

学习 Unix 的资料其实就在系统中，需要学习如何找到这些资料：

**1.从 Unix 中学习 Unix** 

以下四种方法有助于学习 Unix：

- 阅读联机帮助
- 搜索联机帮助
- 阅读 .h 文件
- 从参阅部分（SEE ALSO） 得到启示

**2.阅读联机帮助**

以 who 为例，在命令行输入命令：

```bash
$ man who
...

DESCRIPTION
       Print information about users who are currently logged in.
       
...

If  FILE  is not specified, use /var/run/utmp.  /var/log/wtmp as FILE is common.  If ARG1 ARG2 given, -m presumed: 'am i'  or 'mom  likes' are usual.
```

从上述的 DESCRIPTION 来看，已登录用户信息放在文件 `/var/run/utmp`  中（不同系统文件存放位置也许会有差异），who 通过读取改文件来获取信息。

接下来我们可以通过搜索联机帮助来了解这个文件的结构信息。

**3.搜索联机帮助**

使用带 `-k`  的 man 命令可以根据关键字搜索联机帮助。

接下来查找 ”utmp“ 的信息，在命令行输入：

```bash
$ man -k utmp
endutent (3)         - access utmp file entries
endutxent (3)        - access utmp file entries
getutent (3)         - access utmp file entries
getutent_r (3)       - access utmp file entries
getutid (3)          - access utmp file entries
getutid_r (3)        - access utmp file entries
getutline (3)        - access utmp file entries
getutline_r (3)      - access utmp file entries
getutmp (3)          - copy utmp structure to utmpx, and vice versa
getutmpx (3)         - copy utmp structure to utmpx, and vice versa
getutxent (3)        - access utmp file entries
getutxid (3)         - access utmp file entries
getutxline (3)       - access utmp file entries
login (3)            - write utmp and wtmp entries
logout (3)           - write utmp and wtmp entries
pututline (3)        - access utmp file entries
pututxline (3)       - access utmp file entries
setutent (3)         - access utmp file entries
setutxent (3)        - access utmp file entries
systemd-update-utmp (8) - Write audit and utmp updates at bootup, runlevel changes and sh...
systemd-update-utmp-runlevel.service (8) - Write audit and utmp updates at bootup, runlev...
systemd-update-utmp.service (8) - Write audit and utmp updates at bootup, runlevel change...
utmp (5)             - login records
utmpdump (1)         - dump UTMP and WTMP files in raw format
utmpname (3)         - access utmp file entries
utmpx (5)            - login records
utmpxname (3)        - access utmp file entries
```

注意这一行：

```bash
utmp (5)             - login records
```

这好像就是我们需要的，注意 ”5“ 是小结编号（不同系统的编号可能有所不同），我们需要使用它查找帮助内容：

```bash
$ man 5 umtp
UTMP(5)                          Linux Programmer's Manual                         UTMP(5)

NAME
       utmp, wtmp - login records

SYNOPSIS
       #include <utmp.h>

DESCRIPTION
       The  utmp  file allows one to discover information about who is currently using the
       system.  There may be more users currently using the system, because not  all  pro‐
       grams use utmp logging.

       Warning:  utmp  must not be writable by the user class "other", because many system
       programs (foolishly) depend on its integrity.  You risk faked system  logfiles  and
       modifications of system files if you leave utmp writable to any user other than the
       owner and group owner of the file.

       The file is a sequence of utmp structures, declared as follows  in  <utmp.h>  (note
       that  this is only one of several definitions around; details depend on the version
       of libc):
           /* Values for ut_type field, below */

           #define EMPTY         0 /* Record does not contain valid info
                                      (formerly known as UT_UNKNOWN on Linux) */
           #define RUN_LVL       1 /* Change in system run-level (see
                                      init(8)) */
           #define BOOT_TIME     2 /* Time of system boot (in ut_tv) */
           #define NEW_TIME      3 /* Time after system clock change
           
...

FILES
	   /usr/include/utmp.h
       /var/run/utmp
       /var/log/wtmp

...
 Manual page utmp(5) line 1 (press h for help or q to quit)
```

从上面说明我们可以知道 utmp 这个文件里保存的是**结构数组**，数组元素是 utmp 类型的结构，可以在 `utmp.h`  文件中找到 utmp 类型的定义，接下来我们要找到 utmp.h 的位置，在 FILES 部分我们看到，utmp.h 的位置在 /usr/include 里。

上述提到的 wtmp 文件，这个文件记录了关于登录与注册的信息。

接下来分析 utmp.h 这个文件。

**4.阅读 .h 文件**

Unix 系统中，大多数头文件都存放在 /usr/include 这个目录里，C语言编译器在源程序中发现以下的定义：

```c
include<stdio.h>
```

它会到 /usr/include 中寻找相应的头文件。

接下来使用